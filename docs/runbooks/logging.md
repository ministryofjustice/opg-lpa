# Logging in MaLPA

This is an overview of how we log the progress of a request through the MaLPA stack.

It also covers the philosophy we apply when deciding what to log, and details of how to use our logging classes.

For an overview of how data moves through the stack, see [data flows](./data_flows.md).

## Trace ID logging

We use the incoming `X-Amzn-Trace-Id` header as the key which ties together log entries, as explained below. This header is added to incoming requests coming through the AWS load balancers which sit in front of the *-web containers.

Using the value of this header as a key enables us to trace requests from the load balancers all the way through to back-end services and out again.

**Note that these examples show a mocked-out Amazon trace header, as provided by the *-ssl containers (see next section).**

### Ordering log entries for the public application

For requests to the public application, the log entries arise from the containers in this sequence:

```
1.  front-ssl (local dev) / AWS load balancer
2.  front-web (nginx access log)
3.  front-app (php-fpm access log)
4.  front-app (application log)
5a. api-web (nginx access log)
    1. api-app (php-fpm access log)
    2. api-app (application log)
        1a. RDS
        1b. Sirius
        1c. SQS
5b. dynamodb
5c. pdf-app (application log)
    1. SQS
```

Further explanation:

* front-app talks to api-web, dynamodb and pdf-app. Requests from front-app may therefore trigger log events in one or more of those systems.
* api-app talks to RDS, Sirius and SQS. A call to an endpoint on the API may therefore trigger log events in one or more of those systems.
* pdf-app uses SQS, so jobs generated by front-app or api-app may trigger log events in that system.

If writing a log processor, the timings on the log entries may not provide enough granularity to work out the order of log events. The above sequence should help resolve any ordering ambiguities to reveal the sequence of calls between systems.

### front-ssl/admin-ssl

These containers only exist in dev. They mock the load balancers which pass traffic on to the front-web/admin-web components in live.

Each is an nginx proxy (based on docker-ssl-proxy) modified to proxy requests with additional mock `X-Amzn-Trace-Id` header to the *-web containers.

### front-web/admin-web/api-web

nginx proxies which receive traffic from front-ssl/admin-ssl respectively and forward it to the front-end application (front-app/admin-app). Incoming requests are logged in an access log.

For non-static resources (i.e. requests which are proxied through to the *-app PHP apps), log entries look like this:

```
{
   "trace_id":"Root=1-1608303221.805-152-fromssl",
   "time_local":"18/Dec/2020:14:53:41 +0000",
   "response_time_iso8601":"2020-12-18T14:53:41+00:00",
   "timestamp_msec":"1608303221.895",
   "remote_addr":"192.168.80.9",
   "real_ip":"192.168.80.1",
   "real_forwarded_for":"192.168.80.1",
   "real_forwarded_proto":"https",
   "request_id":"",
   "remote_user":"",
   "request_time":0.090,
   "request_uri":"/home",
   "status":200,
   "request":"GET /home HTTP/1.0",
   "request_method":"GET",
   "http_referrer":"",
   "http_user_agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36",
   "bytes_sent":13044,
   "http_host":"localhost",
   "sent_http_location":"",
   "server_name":"_",
   "server_port":"80",
   "upstream_addr":"192.168.80.17:9000",
   "upstream_response_length":"12656",
   "upstream_response_time":"0.092",
   "upstream_status":"200"
}
```

This format is modelled after the JSON nginx log format used by Sirius.

For static resources, access logging uses combined log format with the addition of the Amazon trace ID at the start of the line:

```
Root=1-1608303221.943-153-fromssl - 192.168.80.9 - - [18/Dec/2020:14:53:41 +0000] "GET /assets/1608303221/v2/css/govuk-template.min.css HTTP/1.0" 200 13995 "https://localhost:7002/home" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36"
```

As requests for static assets are separate from the original request for the page, they will carry different trace IDs.

The `X-Amzn-Trace-Id` header is forwarded with requests proxied to front-app/admin-app but renamed as `X-Trace-Id`.

### front-app/admin-app/api-app

PHP apps running under php-fpm on separate containers. There are two types of logs gathered by each container.

#### 1. php-fpm access log

The access log goes to stdout/stderr in JSON format. The format is close to the one used in the *-web containers and logs incoming requests for PHP resources. It includes a `trace_id` property which can be tied back to the original incoming request.

Example:

```
{
   "trace_id":"Root=1-1608303221.805-152-fromssl",
   "response_time_iso8601":"2020-12-18T14:53:41+0000",
   "time_local":"18/Dec/2020:14:53:41 +0000",
   "remote_addr":"192.168.80.18",
   "real_ip":"192.168.80.1",
   "real_forwarded_for":"192.168.80.1",
   "real_forwarded_proto":"https",
   "request_id":"-",
   "remote_user":"",
   "request_time":"0.073",
   "request_uri":"http://localhost:7002/home",
   "status":"200",
   "request":"GET /home HTTP/1.0",
   "request_method":"GET",
   "http_referrer":"-",
   "http_user_agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36",
   "bytes_sent":"0",
   "http_host":"localhost:7002",
   "server_name":"_",
   "server_port":"80"
}
```

#### 2. Application log

These also output to stdout/stderr but are in a slightly expanded format, containing less information about IP addresses but more information about the request, such as its headers. Each entry also contains a reference to the `trace_id` of the original request which generated the error.

When a PHP error occurs, log entries also contain additional logging about the file which caused the error, the exception stacktrace and other useful data.

Other informational/debug application logging is output in a similar format. The `$extra` argument which can be passed to Laminas' logger methods can be used to provide extra context. See the section on PHP logging below for more details.

Example log output for an exception thrown by a controller:

```
{
   "timestamp":"2020-12-18T14:56:55+00:00",
   "priority":3,
   "priorityName":"ERR",
   "message":"dispatch.error",
   "trace_id":"Root=1-1608303415.248-371-fromssl",
   "request":{
      "uri":"https://localhost:7002/home",
      "method":"GET",
      "headers":{
         "Accept-Language":"en-GB, en-US;q=0.9, en;q=0.8",
         "Accept-Encoding":"gzip, deflate, br",
         "Sec-Fetch-Dest":"document",
         "Sec-Fetch-User":"?1",
         "Sec-Fetch-Mode":"navigate",
         "Sec-Fetch-Site":"none",
         "Accept":"text/html, application/xhtml+xml, application/xml;q=0.9, image/avif, image/webp, image/apng, */*;q=0.8, application/signed-exchange;v=b3;q=0.9",
         "User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36",
         "Upgrade-Insecure-Requests":1,
         "Cache-Control":"max-age=0",
         "X-Amzn-Trace-Id":"Root=1-1608303415.248-371-fromssl",
         "Connection":"close",
         "X-Forwarded-Host":"localhost",
         "X-Forwarded-Proto":"https",
         "X-Forwarded-For":"192.168.80.1",
         "X-Real-Ip":"192.168.80.1",
         "Host":"localhost:7002",
         "X-Trace-Id":"Root=1-1608303415.248-371-fromssl"
      }
   },
   "controller":"General\\HomeController",
   "exception":{
      "message":"EXCEPTION FORCED FOR DEMO PURPOSES",
      "file":"/app/module/Application/src/Controller/General/HomeController.php",
      "line":15,
      "stackTrace":"#0 /app/vendor/laminas/laminas-mvc/src/Controller/AbstractActionController.php(77): Application\\Controller\\General\\HomeController->indexAction()\n#1 /app/vendor/laminas/laminas-eventmanager/src/EventManager.php(331): Laminas\\Mvc\\Controller\\AbstractActionController->onDispatch(Object(Laminas\\Mvc\\MvcEvent))\n#2 /app/vendor/laminas/laminas-eventmanager/src/EventManager.php(188): Laminas\\EventManager\\EventManager->triggerListeners(Object(Laminas\\Mvc\\MvcEvent), Object(Closure))\n#3 /app/vendor/laminas/laminas-mvc/src/Controller/AbstractController.php(103): Laminas\\EventManager\\EventManager->triggerEventUntil(Object(Closure), Object(Laminas\\Mvc\\MvcEvent))\n#4 /app/vendor/laminas/laminas-mvc/src/DispatchListener.php(139): Laminas\\Mvc\\Controller\\AbstractController->dispatch(Object(Laminas\\Http\\PhpEnvironment\\Request), Object(Laminas\\Http\\PhpEnvironment\\Response))\n#5 /app/vendor/laminas/laminas-eventmanager/src/EventManager.php(331): Laminas\\Mvc\\DispatchListener->onDispatch(Object(Laminas\\Mvc\\MvcEvent))\n#6 /app/vendor/laminas/laminas-eventmanager/src/EventManager.php(188): Laminas\\EventManager\\EventManager->triggerListeners(Object(Laminas\\Mvc\\MvcEvent), Object(Closure))\n#7 /app/vendor/laminas/laminas-mvc/src/Application.php(331): Laminas\\EventManager\\EventManager->triggerEventUntil(Object(Closure), Object(Laminas\\Mvc\\MvcEvent))\n#8 /app/public/index.php(31): Laminas\\Mvc\\Application->run()\n#9 {main}"
   },
   "errorMessage":"error-exception"
}
```

## PHP logging

???TODO

???where logging is configured for service-front

???special processor for MvcEvents

???how $extra is used to provide additional data to the log methods
